# Grapplay 결제 테스트 체크리스트

> 론칭 전 모든 결제 시나리오를 검증하기 위한 테스트 체크리스트

## 테스트 환경 설정

### 필수 확인 사항
- [ ] PortOne 테스트 모드 활성화 확인
- [ ] PayPal Sandbox 모드 활성화 확인
- [ ] Supabase Edge Functions 배포 완료
- [ ] 환경변수 설정 완료:
  - `VITE_PORTONE_STORE_ID`
  - `VITE_PORTONE_CHANNEL_KEY_GENERAL` (일반 결제용)
  - `VITE_PORTONE_CHANNEL_KEY_SUBSCRIPTION` (정기결제용)
  - `PORTONE_API_SECRET`
  - `PORTONE_WEBHOOK_SECRET`
  - `VITE_PAYPAL_CLIENT_ID`

### 테스트 카드 정보 (PortOne)
- 카드번호: `4242-4242-4242-4242`
- 유효기간: 아무 미래 날짜
- CVC: 아무 3자리
- 비밀번호: 아무 2자리

---

## 1. 구독 결제 테스트

### 1.1 월간 구독 (Basic) - 정기결제
| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | `/pricing` 페이지 접근 | 1개월/1년 플랜 표시 | [ ] |
| 2 | "1개월 시작하기" 클릭 | `/checkout/subscription/{priceId}` 이동 | [ ] |
| 3 | 이름/전화번호 입력 | 입력 필드 정상 동작 | [ ] |
| 4 | "정기결제 시작하기" 클릭 | PortOne 결제창 오픈 (Billing Key 발급) | [ ] |
| 5 | 테스트 카드로 결제 | 결제 성공 | [ ] |
| 6 | 결제 완료 페이지 | `/payment/complete` 이동, 성공 메시지 | [ ] |
| 7 | DB 확인: `users` | `is_subscriber=true`, `subscription_tier='basic'` | [ ] |
| 8 | DB 확인: `subscriptions` | `status='active'`, `plan_interval='month'`, `billing_key` 존재 | [ ] |
| 9 | DB 확인: `payments` | 결제 내역 생성됨 | [ ] |
| 10 | 알림 확인 | 결제 성공 알림 수신 | [ ] |

### 1.2 연간 구독 (Basic) - 1회 결제
| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | "1년 구독 신청" 클릭 | `/checkout/subscription/{yearlyPriceId}` 이동 | [ ] |
| 2 | 결제 배지 확인 | "1회 결제 (12개월 이용권)" 표시 | [ ] |
| 3 | "결제하기" 클릭 | PortOne 일반 결제창 오픈 | [ ] |
| 4 | 테스트 카드로 결제 | 결제 성공 | [ ] |
| 5 | DB 확인: `subscriptions` | `plan_interval='year'`, `billing_key=null` | [ ] |
| 6 | DB 확인: `revenue_ledger` | 12개월치 분할 인식 레코드 생성 | [ ] |

### 1.3 구독 업그레이드 (월→연)
| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 월간 구독 상태에서 Settings 접근 | 업그레이드 옵션 표시 | [ ] |
| 2 | 업그레이드 결제 진행 | 잔여 기간 차감 금액 계산됨 | [ ] |
| 3 | 결제 완료 | 구독 기간 1년으로 변경됨 | [ ] |

### 1.4 구독 취소
| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | Settings에서 "구독 취소" 클릭 | 취소 확인 모달 표시 | [ ] |
| 2 | "기간 종료 후 취소" 선택 | `status='canceling'`, 현재 기간까지 이용 가능 | [ ] |
| 3 | "즉시 취소" 선택 | `status='canceled'`, `is_subscriber=false` | [ ] |
| 4 | 예약 결제 취소 | PortOne에서 scheduled payment 취소됨 | [ ] |
| 5 | Billing Key 삭제 | PortOne에서 billing key 삭제됨 | [ ] |
| 6 | 취소 알림 | 취소 완료 알림 수신 | [ ] |

---

## 2. 단품 구매 테스트

### 2.1 코스 구매
| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 코스 상세 페이지 접근 | 가격, 구매 버튼 표시 | [ ] |
| 2 | "구매하기" 클릭 | `/checkout/course/{id}` 이동 | [ ] |
| 3 | PortOne 결제 완료 | 결제 성공 | [ ] |
| 4 | DB 확인: `course_enrollments` | 수강 등록 생성됨 | [ ] |
| 5 | DB 확인: `revenue_ledger` | 수익 분배 레코드 (플랫폼 20%, 크리에이터 80%) | [ ] |
| 6 | 코스 접근 | 구매한 코스 시청 가능 | [ ] |

### 2.2 루틴 구매
| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 루틴 상세 페이지 접근 | 가격, 구매 버튼 표시 | [ ] |
| 2 | 결제 완료 | DB: `user_routines` 생성됨 | [ ] |
| 3 | 루틴 접근 | 구매한 루틴 이용 가능 | [ ] |

### 2.3 드릴 구매
| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 드릴 상세 페이지 접근 | 가격, 구매 버튼 표시 | [ ] |
| 2 | 결제 완료 | DB: `user_drills` 생성됨, `price_paid` 기록 | [ ] |
| 3 | 드릴 접근 | 구매한 드릴 시청 가능 | [ ] |

### 2.4 스파링 영상 구매
| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 스파링 영상 상세 접근 | 가격, 구매 버튼 표시 | [ ] |
| 2 | 결제 완료 | DB: `user_videos` 생성됨 | [ ] |
| 3 | 영상 접근 | 구매한 영상 시청 가능 | [ ] |

### 2.5 번들 구매
| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 번들 상세 페이지 접근 | 포함된 코스/드릴 목록, 가격 표시 | [ ] |
| 2 | 결제 완료 | DB: `user_bundles` 생성됨 | [ ] |
| 3 | 포함 콘텐츠 등록 | 번들에 포함된 모든 코스/드릴 자동 등록됨 | [ ] |

### 2.6 피드백 요청 결제
| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 피드백 요청 생성 | 가격 설정됨 | [ ] |
| 2 | 결제 완료 | `feedback_requests.payment_status='paid'` | [ ] |
| 3 | 수익 분배 | 플랫폼 20%, 크리에이터 80% 기록 | [ ] |

---

## 3. 쿠폰 기능 테스트

| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 유효한 쿠폰 코드 입력 | 할인 적용, 최종 금액 변경 | [ ] |
| 2 | 퍼센트 할인 쿠폰 | 정확한 할인율 계산 | [ ] |
| 3 | 고정 금액 할인 쿠폰 | 정확한 할인 금액 차감 | [ ] |
| 4 | 만료된 쿠폰 | "유효하지 않은 쿠폰" 에러 | [ ] |
| 5 | 존재하지 않는 쿠폰 | "유효하지 않은 쿠폰" 에러 | [ ] |
| 6 | 쿠폰 취소 | 원래 금액으로 복원 | [ ] |

---

## 4. 해외 결제 (PayPal) 테스트

| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 해외 결제 탭 선택 | PayPal 버튼 표시 | [ ] |
| 2 | USD 환산 금액 확인 | KRW/1430 = USD 금액 표시 | [ ] |
| 3 | PayPal 버튼 클릭 | PayPal 결제창 오픈 | [ ] |
| 4 | Sandbox 계정으로 결제 | 결제 성공 | [ ] |
| 5 | `verify-paypal-payment` 호출 | 결제 검증 성공 | [ ] |
| 6 | DB 업데이트 | 해당 상품 접근권 부여됨 | [ ] |

---

## 5. 결제 실패 시나리오

| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 결제 도중 취소 | "결제가 취소되었습니다" 알림 | [ ] |
| 2 | 카드 한도 초과 (시뮬레이션) | 결제 실패 메시지, 실패 알림 | [ ] |
| 3 | 네트워크 오류 | 에러 처리, 재시도 가능 | [ ] |
| 4 | 미인증 상태 결제 시도 | 로그인 페이지 리다이렉트 | [ ] |

---

## 6. Webhook 테스트

### 6.1 PortOne Webhook (`portone-webhook`)
| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | Webhook 서명 검증 | 유효하지 않은 서명 거부 (401) | [ ] |
| 2 | `Transaction.Paid` 이벤트 | 구독 갱신, 다음 결제 예약 | [ ] |
| 3 | `Transaction.Failed` 이벤트 | `status='past_due'`, 결제 실패 알림 | [ ] |
| 4 | `BillingKey.Deleted` 이벤트 | 구독 취소 처리 | [ ] |

### 6.2 정기결제 갱신 테스트
| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 예약된 결제 실행 | 자동 결제 진행 | [ ] |
| 2 | 구독 기간 갱신 | `current_period_end` 1개월 연장 | [ ] |
| 3 | 다음 결제 예약 | 새로운 `scheduled_payment_id` 설정 | [ ] |
| 4 | 결제 내역 기록 | `payments` 테이블에 기록 | [ ] |

---

## 7. 접근 권한 테스트

| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 구독자 → 프리미엄 콘텐츠 | 모든 콘텐츠 접근 가능 | [ ] |
| 2 | 비구독자 → 무료 콘텐츠 | 무료 콘텐츠만 접근 가능 | [ ] |
| 3 | 비구독자 → 유료 콘텐츠 | 구매/구독 유도 화면 | [ ] |
| 4 | 단품 구매자 → 해당 콘텐츠 | 구매한 콘텐츠만 접근 가능 | [ ] |
| 5 | 구독 만료 후 | 콘텐츠 접근 차단됨 | [ ] |
| 6 | 관리자 (`is_admin`) | 모든 콘텐츠 접근 가능 | [ ] |
| 7 | 무료 구독 (`is_complimentary_subscription`) | 모든 콘텐츠 접근 가능 | [ ] |

---

## 8. 수익 정산 테스트

| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 단품 판매 수익 분배 | 플랫폼 20%, 크리에이터 80% | [ ] |
| 2 | 연간 구독 분할 인식 | 12개월 나눠서 `revenue_ledger` 기록 | [ ] |
| 3 | 크리에이터 대시보드 | 판매 내역, 수익 확인 가능 | [ ] |

---

## 9. UI/UX 테스트

| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 모바일 반응형 | 결제 페이지 모바일에서 정상 표시 | [ ] |
| 2 | 로딩 상태 | 결제 처리 중 로딩 인디케이터 | [ ] |
| 3 | 에러 메시지 | 사용자 친화적 에러 메시지 | [ ] |
| 4 | 뒤로가기 | 결제 취소 시 이전 페이지로 이동 | [ ] |
| 5 | returnUrl 유지 | 결제 완료 후 원래 페이지로 복귀 | [ ] |

---

## 10. 보안 테스트

| 단계 | 테스트 항목 | 예상 결과 | 통과 |
|------|------------|----------|------|
| 1 | 금액 조작 시도 | 서버에서 금액 재검증 | [ ] |
| 2 | 인증 없이 API 호출 | 401 Unauthorized | [ ] |
| 3 | 다른 사용자 구독 취소 시도 | 권한 없음 에러 | [ ] |
| 4 | Webhook 위조 시도 | 서명 검증 실패 | [ ] |

---

## 테스트 완료 체크리스트

- [ ] 모든 구독 결제 시나리오 통과
- [ ] 모든 단품 구매 시나리오 통과
- [ ] 쿠폰 기능 정상 작동
- [ ] PayPal 해외 결제 정상 작동
- [ ] Webhook 정상 수신 및 처리
- [ ] 결제 실패 케이스 적절히 처리
- [ ] 접근 권한 정확히 적용
- [ ] 수익 정산 정확히 계산
- [ ] 모바일 UI 정상 작동
- [ ] 보안 취약점 없음

---

## 테스트 담당자

| 역할 | 담당자 | 완료일 |
|------|--------|-------|
| 국내 결제 (PortOne) | | |
| 해외 결제 (PayPal) | | |
| 구독 관리 | | |
| DB 검증 | | |
| UI/UX 검수 | | |

---

## 이슈 트래킹

| # | 이슈 내용 | 발생 시나리오 | 상태 | 해결일 |
|---|----------|-------------|------|-------|
| 1 | | | | |
| 2 | | | | |
| 3 | | | | |

---

## 프로덕션 전환 체크리스트

- [ ] PortOne 실서버 모드 전환
- [ ] PayPal 실서버 모드 전환
- [ ] 환경변수 프로덕션 값으로 변경
- [ ] Webhook URL 프로덕션으로 설정
- [ ] 최종 통합 테스트 완료
