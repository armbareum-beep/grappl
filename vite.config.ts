import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'
import fs from 'fs'
import path from 'path'

// Read version from public/version.json (generated by generate-version.js)
let appVersion = ''
try {
    const versionFile = path.resolve(__dirname, 'public/version.json')
    if (fs.existsSync(versionFile)) {
        const data = JSON.parse(fs.readFileSync(versionFile, 'utf-8'))
        appVersion = data.version
    }
} catch (e) {
    console.warn('Failed to read version.json')
}

// Fallback to direct git hash if version is still empty
if (!appVersion) {
    try {
        const { execSync } = await import('child_process')
        appVersion = execSync('git rev-parse --short HEAD').toString().trim()
        console.log(`[ViteConfig] Version fallback to git: ${appVersion}`)
    } catch (e) {
        appVersion = Date.now().toString()
        console.warn(`[ViteConfig] Version fallback to timestamp: ${appVersion}`)
    }
}

// https://vitejs.dev/config/
export default defineConfig({
    plugins: [
        react(),
        VitePWA({
            // ✅ 간소화: 앱 설치 기능만 유지, 캐싱은 비활성화
            registerType: 'autoUpdate',
            injectRegister: 'auto',
            workbox: {
                skipWaiting: true,
                clientsClaim: true,
                cleanupOutdatedCaches: true,
                // ❌ JS/CSS/HTML 캐싱 완전 비활성화 - 브라우저 기본 캐싱만 사용
                globPatterns: [], // 아무것도 precache 안 함
                navigateFallback: null,
                // ✅ 런타임 캐싱도 최소화: 폰트만 캐시
                runtimeCaching: [
                    // Fonts만 캐시 (거의 안 바뀜)
                    {
                        urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
                        handler: 'CacheFirst',
                        options: {
                            cacheName: 'google-fonts-cache',
                            expiration: { maxEntries: 10, maxAgeSeconds: 60 * 60 * 24 * 365 }
                        }
                    },
                    {
                        urlPattern: /^https:\/\/fonts\.gstatic\.com\/.*/i,
                        handler: 'CacheFirst',
                        options: {
                            cacheName: 'gstatic-fonts-cache',
                            expiration: { maxEntries: 20, maxAgeSeconds: 60 * 60 * 24 * 365 }
                        }
                    }
                    // 나머지는 모두 브라우저 기본 동작 (네트워크 요청)
                ]
            },
            includeAssets: ['favicon.ico', 'apple-touch-icon.png', 'mask-icon.svg'],
            manifest: {
                name: 'Grapplay',
                short_name: 'Grapplay',
                description: '프리미엄 주짓수 기술 영상 플랫폼',
                theme_color: '#09090b',
                background_color: '#09090b',
                display: 'standalone',
                start_url: '/',
                icons: [
                    {
                        src: 'pwa-192x192.png',
                        sizes: '192x192',
                        type: 'image/png',
                        purpose: 'any maskable'
                    },
                    {
                        src: 'pwa-512x512.png',
                        sizes: '512x512',
                        type: 'image/png',
                        purpose: 'any maskable'
                    }
                ]
            }
        }),
    ],
    define: {
        'import.meta.env.VITE_APP_VERSION': JSON.stringify(appVersion),
    },
    build: {
        rollupOptions: {
            output: {
                manualChunks: (id) => {
                    // React core - MUST be in the same chunk to avoid internal state issues
                    if (id.includes('node_modules/react/') ||
                        id.includes('node_modules/react-dom/') ||
                        id.includes('node_modules/scheduler/')) {
                        return 'react-vendor';
                    }
                    if (id.includes('react-router')) {
                        return 'react-router';
                    }

                    // Supabase - needed early but can be separate
                    if (id.includes('@supabase')) {
                        return 'supabase';
                    }

                    // React Query
                    if (id.includes('@tanstack/react-query')) {
                        return 'react-query';
                    }

                    // Sentry - deferred loading
                    if (id.includes('@sentry')) {
                        return 'sentry';
                    }

                    // PayPal - only for checkout
                    if (id.includes('@paypal')) {
                        return 'paypal';
                    }

                    // Video players - only when watching
                    if (id.includes('@vimeo/player') || id.includes('tus-js-client')) {
                        return 'video';
                    }

                    // Heavy animation/visualization
                    if (id.includes('framer-motion')) {
                        return 'framer-motion';
                    }
                    if (id.includes('reactflow')) {
                        return 'reactflow';
                    }
                    if (id.includes('recharts')) {
                        return 'recharts';
                    }

                    // DnD Kit - creator/admin only
                    if (id.includes('@dnd-kit')) {
                        return 'dnd-kit';
                    }

                    // Embla Carousel
                    if (id.includes('embla-carousel')) {
                        return 'embla';
                    }

                    // Icons - frequently used
                    if (id.includes('lucide-react')) {
                        return 'icons';
                    }

                    // Date utilities
                    if (id.includes('date-fns')) {
                        return 'date-fns';
                    }

                    // Admin pages
                    if (id.includes('/pages/admin/')) {
                        return 'admin-pages';
                    }

                    // Creator pages
                    if (id.includes('/pages/creator/')) {
                        return 'creator-pages';
                    }
                }
            }
        },
        chunkSizeWarningLimit: 1000, // 경고 임계값 상향 (1MB)
        minify: 'terser', // 더 강력한 압축
        terserOptions: {
            compress: {
                drop_console: true, // 프로덕션에서 console.log 제거
                drop_debugger: true,
                pure_funcs: ['console.log', 'console.info', 'console.debug']
            }
        },
        sourcemap: false, // 프로덕션 빌드에서 소스맵 제거 (크기 절약)
    },
    esbuild: {
        drop: process.env.NODE_ENV === 'production' ? ['console', 'debugger'] : [],
    },
    server: {
        // port: 8080, // Removed to allow default (5173) or flexible port
        open: true,
        proxy: {
            '/process': {
                target: 'http://localhost:8081',
                changeOrigin: true,
            },
            '/api': {
                target: 'http://localhost:8081',
                changeOrigin: true,
            },
            '/temp': {
                target: 'http://localhost:8081',
                changeOrigin: true,
            }
        }
    }
})

// Touch to force reload

// Touch to force reload
