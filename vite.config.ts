import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'
import fs from 'fs'
import path from 'path'

// Read version from public/version.json (generated by generate-version.js)
let appVersion = ''
try {
    const versionFile = path.resolve(__dirname, 'public/version.json')
    if (fs.existsSync(versionFile)) {
        const data = JSON.parse(fs.readFileSync(versionFile, 'utf-8'))
        appVersion = data.version
    }
} catch (e) {
    console.warn('Failed to read version.json')
}

// Fallback to direct git hash if version is still empty
if (!appVersion) {
    try {
        const { execSync } = await import('child_process')
        appVersion = execSync('git rev-parse --short HEAD').toString().trim()
        console.log(`[ViteConfig] Version fallback to git: ${appVersion}`)
    } catch (e) {
        appVersion = Date.now().toString()
        console.warn(`[ViteConfig] Version fallback to timestamp: ${appVersion}`)
    }
}

// https://vitejs.dev/config/
export default defineConfig({
    plugins: [
        react(),
        VitePWA({
            registerType: 'autoUpdate',
            injectRegister: 'auto',
            workbox: {
                skipWaiting: true,
                clientsClaim: true,
                cleanupOutdatedCaches: true,
                // CRITICAL: Minimize precache to prevent stale cache issues
                // Only precache essential shell files, not all JS chunks
                globPatterns: ['**/*.{ico,png,svg,webp}'], // Only icons/images
                // Don't precache JS/CSS - use runtime caching instead
                navigateFallback: null, // Disable offline fallback to index.html
                navigateFallbackDenylist: [/^\/api/, /^\/__/],
                runtimeCaching: [
                    // HTML - Always fetch from network first
                    {
                        urlPattern: /^https:\/\/.*\/?$/i,
                        handler: 'NetworkFirst',
                        options: {
                            cacheName: 'html-cache',
                            expiration: {
                                maxEntries: 10,
                                maxAgeSeconds: 60 * 60 // 1 hour
                            },
                            networkTimeoutSeconds: 3,
                            cacheableResponse: {
                                statuses: [0, 200]
                            }
                        }
                    },
                    // JS/CSS - Stale while revalidate (use cache but update in background)
                    {
                        urlPattern: /\.(?:js|css)$/i,
                        handler: 'StaleWhileRevalidate',
                        options: {
                            cacheName: 'static-resources',
                            expiration: {
                                maxEntries: 100,
                                maxAgeSeconds: 60 * 60 * 24 * 7 // 7 days
                            },
                            cacheableResponse: {
                                statuses: [0, 200]
                            }
                        }
                    },
                    // Fonts - Cache first (rarely change)
                    {
                        urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
                        handler: 'CacheFirst',
                        options: {
                            cacheName: 'google-fonts-cache',
                            expiration: {
                                maxEntries: 10,
                                maxAgeSeconds: 60 * 60 * 24 * 365 // 1 year
                            },
                            cacheableResponse: {
                                statuses: [0, 200]
                            }
                        }
                    },
                    {
                        urlPattern: /^https:\/\/fonts\.gstatic\.com\/.*/i,
                        handler: 'CacheFirst',
                        options: {
                            cacheName: 'gstatic-fonts-cache',
                            expiration: {
                                maxEntries: 20,
                                maxAgeSeconds: 60 * 60 * 24 * 365 // 1 year
                            },
                            cacheableResponse: {
                                statuses: [0, 200]
                            }
                        }
                    },
                    // API calls - Network only (never cache)
                    {
                        urlPattern: /\/api\//i,
                        handler: 'NetworkOnly'
                    },
                    // Supabase - Network only
                    {
                        urlPattern: /supabase/i,
                        handler: 'NetworkOnly'
                    }
                ]
            },
            includeAssets: ['favicon.ico', 'apple-touch-icon.png', 'mask-icon.svg'],
            manifest: {
                name: 'Grapplay',
                short_name: 'Grapplay',
                description: '프리미엄 주짓수 기술 영상 플랫폼',
                theme_color: '#09090b',
                background_color: '#09090b',
                display: 'standalone',
                start_url: '/',
                icons: [
                    {
                        src: 'pwa-192x192.png',
                        sizes: '192x192',
                        type: 'image/png',
                        purpose: 'any maskable'
                    },
                    {
                        src: 'pwa-512x512.png',
                        sizes: '512x512',
                        type: 'image/png',
                        purpose: 'any maskable'
                    }
                ]
            }
        }),
    ],
    define: {
        'import.meta.env.VITE_APP_VERSION': JSON.stringify(appVersion),
    },
    build: {
        rollupOptions: {
            output: {
                manualChunks: (id) => {
                    // React 관련 라이브러리
                    if (id.includes('node_modules/react') ||
                        id.includes('node_modules/react-dom') ||
                        id.includes('node_modules/react-router')) {
                        return 'react-vendor';
                    }

                    // Supabase 클라이언트
                    if (id.includes('@supabase/supabase-js')) {
                        return 'supabase';
                    }

                    // React Query
                    if (id.includes('@tanstack/react-query')) {
                        return 'react-query';
                    }

                    // 비디오 관련
                    if (id.includes('@vimeo/player') || id.includes('tus-js-client')) {
                        return 'video';
                    }

                    // 무거운 라이브러리들 - 별도 청크로 분리
                    if (id.includes('framer-motion')) {
                        return 'framer-motion';
                    }

                    if (id.includes('reactflow')) {
                        return 'reactflow';
                    }

                    if (id.includes('recharts')) {
                        return 'recharts';
                    }

                    // DnD Kit
                    if (id.includes('@dnd-kit')) {
                        return 'dnd-kit';
                    }

                    // UI 라이브러리
                    if (id.includes('lucide-react') || id.includes('date-fns')) {
                        return 'ui';
                    }

                    // Admin 페이지들 - 별도 청크
                    if (id.includes('/pages/admin/')) {
                        return 'admin-pages';
                    }

                    // Creator 페이지들 - 별도 청크
                    if (id.includes('/pages/creator/')) {
                        return 'creator-pages';
                    }
                }
            }
        },
        chunkSizeWarningLimit: 1000, // 경고 임계값 상향 (1MB)
        minify: 'terser', // 더 강력한 압축
        terserOptions: {
            compress: {
                drop_console: true, // 프로덕션에서 console.log 제거
                drop_debugger: true,
                pure_funcs: ['console.log', 'console.info', 'console.debug']
            }
        },
        sourcemap: false, // 프로덕션 빌드에서 소스맵 제거 (크기 절약)
    },
    esbuild: {
        drop: process.env.NODE_ENV === 'production' ? ['console', 'debugger'] : [],
    },
    server: {
        // port: 8080, // Removed to allow default (5173) or flexible port
        open: true,
        proxy: {
            '/process': {
                target: 'http://localhost:8081',
                changeOrigin: true,
            },
            '/api': {
                target: 'http://localhost:8081',
                changeOrigin: true,
            },
            '/temp': {
                target: 'http://localhost:8081',
                changeOrigin: true,
            }
        }
    }
})

// Touch to force reload

// Touch to force reload
